<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="description" content="Control de gastos, objetivos y más">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Finanzas</title>
	<style>
		*,
		*:before,
		*:after {
			box-sizing: border-box;
		}
		:root {
			--black: #212121;
			--font: #616161;
			--link: #007bff;
			--blue: #007bff;
			--purple: #a126ff;
			--min-height: calc(100vh - 18rem);
		}
		html {
			background: white;
			color: var(--font);
			font-family: 'Open Sans', 'Ubuntu', 'Century gothic', arial, sans-serif;
			font-size: 16px;
		}
		.input_container label *:not([hidden]) {
			width: 100%;
			display: block;
		}
		.input_container label {
			display: flex;
			flex-direction: column-reverse;
			margin-bottom: 1rem;
		}
		#image_thumbnail.y {
			max-height: 100px;
		}
		#image_thumbnail.x {
			max-width: 100px;
		}
		#image_thumbnail:not(.x):not(.y) {
		    max-height: 100px;
		    max-width: 100px;
		}
		img {
			max-width: 100%;
		}
	</style>
</head>
<body>
	<nav>
		<a href="#">Objetivos</a>
		<a href="#">Metas</a>
	</nav>
	<section id="table_container" class="items"></section>
	<form>
		<input id="id" name="id" type="hidden">
		<div class="input_container">
			<label>
				<input id="nombre" name="nombre" type="text" required>
				<span>Nombre</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="alias" name="alias" type="text">
				<span>Alias <small>(Nombre corto)</small></span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="precio" name="precio" type="number">
				<span>Monto</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="fecha" name="fecha" type="date">
				<span>Fecha</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="image_mode" type="checkbox">
				<span>Imagen por URL</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="upload_image" type="file">
				<input id="image_url" type="url" placeholder="Pega la URL de la imagen" hidden>
				<span>Imagen</span>
			</label>
			<img id="image_thumbnail" src="" alt="Imagén de tu meta">
			<input id="imagen" name="imagen" type="hidden">
		</div>
		<div class="input_container">
			<label>
				<select name="objetivo" id="objetivo"></select>
				<span>Objetivo</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<select name="categoria" id="categoria" multiple></select>
				<span>Categoria</span>
			</label>
		</div>
		<button type="reset">Cancelar</button>
		<button type="submit" disabled>Aceptar</button>
	</form>
	<script>
		/*
			MAXIMUN GERRERO PECHOS_DE_ADAMATIUM LOMO_PLATEADO EMPLAZADOR AZTECA DE-BRONCE/PLATA/ORO/DIAMANTE SUPER_SAYAN GOOD/ULTRA-GOOD // Gaminficación de nivel de usuario para comunidad HUNTER
			Este nivel exige la más alta beneración de la comunidad. Sus palabras van más alla de la verdad, sera benerado y aclamado por todos y TU LENGUA estara a merced de sus genitales COMO y CUANDO quiera 
		*/
		developerMode	= true
		messages		= {
								error_init	: `En navegador con el que cuentas, no soporta las tecnologias requeridas para el funcionamiento de esta web app`,
								no_data		: `No hay datos para mostrar`
							}
		class DB {
			constructor(nameDB) {
				this.name		= nameDB
				this.db			= openDatabase(this.name, '1.0', this.name, 2 * 1024 * 1024) // Base de datos 2MB
				this.messages	= {
										message_1 : 'Tabla creada correctamente.',
										message_2 : 'No se especifico el nombre de la tabla a eliminar.',
										message_3 : 'Registro agregado correctamente.',
										message_4 : '¿Deseas eliminar todas tus metas?',
										message_5 : '¡¿En serio?!',
										message_6 : '¿Estas seguro?',
										message_7 : '¿Deberas?',
										message_8 : '¿Deberitas?',
										message_9 : '¡¡¡Esta es la ultima oportuniad!!!',
										message_10 : 'Bueno otra y ya',
										message_11 : '¡¡¡Ah!!! NO PUEDES.\nNo tienes permisos. ;)',
										message_12 : 'No te creas, es broma.\nYa estan eliminados.\nSer ambicioso con moderación no es malo.\nCrea una nueva meta. Animate',
									}
			}
			init() {
				if (this.db) {
					const goals = `CREATE TABLE IF NOT EXISTS metas (
																			id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
																			nombre TEXT NOT NULL,
																			alias TEXT,
																			precio REAL DEFAULT 0.00,
																			fecha TEXT,
																			imagen TEXT,
																			orden INTEGER DEFAULT 0,
																			fecha_creacion TEXT DEFAULT CURRENT_TIMESTAMP,
																			fecha_update TEXT DEFAULT CURRENT_TIMESTAMP,
																			estatus INTEGER DEFAULT 1
																		)`
					const goalsCategories = `CREATE TABLE IF NOT EXISTS metas_categorias (
																			id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
																			nombre TEXT NOT NULL,
																			descripcion TEXT NOT NULL,
																			color TEXT,
																			imagen TEXT,
																			orden INTEGER DEFAULT 0,
																			fecha_creacion TEXT DEFAULT CURRENT_TIMESTAMP,
																			fecha_update TEXT DEFAULT CURRENT_TIMESTAMP,
																			estatus INTEGER DEFAULT 1
																		)`
					const objetives = `CREATE TABLE IF NOT EXISTS objetivos (
																			id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
																			nombre TEXT NOT NULL,
																			alias TEXT,
																			imagen TEXT,
																			fecha_creacion TEXT DEFAULT CURRENT_TIMESTAMP,
																			fecha_update TEXT DEFAULT CURRENT_TIMESTAMP,
																			estatus INTEGER DEFAULT 1
																		)`
					const objectivesCategories = `CREATE TABLE IF NOT EXISTS objetivos_categorias (
																			id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
																			nombre TEXT NOT NULL,
																			descripcion TEXT NOT NULL,
																			color TEXT,
																			imagen TEXT,
																			orden INTEGER DEFAULT 0,
																			fecha_creacion TEXT DEFAULT CURRENT_TIMESTAMP,
																			fecha_update TEXT DEFAULT CURRENT_TIMESTAMP,
																			estatus INTEGER DEFAULT 1
																		)`
					this.execute(goals)
					this.execute(objetives)
				}
			}
			getTable(nameTable, callBack) {
				const instruction = `SELECT * FROM ${nameTable}`
				this.db.transaction(function(transaction) {
					transaction.executeSql(instruction, [], function(transaction, results) {
						let datas = []
						if (results.rows.length) {
							for (let i = 0; i < results.rows.length; i++)
								datas.push({
												id		: results.rows[i].id,
												img		: results.rows[i].imagen,
												name	: results.rows[i].nombre,
												alias	: results.rows[i].alias,
												price	: results.rows[i].precio,
												date	: results.rows[i].fecha,
											})
						}
				    	callBack(datas)
					})
				})
			}
			execute(instruction) {
				this.db.transaction(function(transaction) {
					transaction.executeSql(instruction)
				}, this.errorHandler, this.successHandler(this.messages.message_1))
			}
			insert(queryInsert, datas) {
				this.db.transaction(function(transaction) {
					transaction.executeSql(queryInsert, datas)
				}, this.errorHandler, this.successHandler(this.messages.message_3))
				return true
			}
			errorHandler(transaction) {
				if (developerMode)
					console.error(transaction)
			}
			successHandler(transaction) {
				if (developerMode)
					console.info(transaction)
			}
			deleteAllTable(nameTable) {
				if (nameTable) {
					if (confirm(this.messages.message_4)) {
						if (confirm(this.messages.message_5)) {
							if (confirm(this.messages.message_6)) {
								if (confirm(this.messages.message_7)) {
									if (confirm(this.messages.message_8)) {
										if (confirm(this.messages.message_9)) {
											if (confirm(this.messages.message_10)) {
												alert(this.messages.message_11)
												const deleteTable = `DELETE FROM ${nameTable}`
												this.execute(deleteTable)
												alert(this.messages.message_12)
											}
										} 
									}
								}
							}
						}
					}
				} else console.error(this.messages.message_2)
			}
		}
		const imageThumbnail = () => `data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNDI2LjY2NyA0MjYuNjY3IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA0MjYuNjY3IDQyNi42Njc7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnPg0KCTxnPg0KCQk8Y2lyY2xlIGN4PSIyMTMuMzMzIiBjeT0iMjM0LjY2NyIgcj0iNjguMjY3Ii8+DQoJPC9nPg0KPC9nPg0KPGc+DQoJPGc+DQoJCTxwYXRoIGQ9Ik0zODQsNjRoLTY3LjYyN2wtMzkuMDQtNDIuNjY3aC0xMjhMMTEwLjI5Myw2NEg0Mi42NjdDMTkuMDkzLDY0LDAsODMuMDkzLDAsMTA2LjY2N3YyNTYNCgkJCWMwLDIzLjU3MywxOS4wOTMsNDIuNjY3LDQyLjY2Nyw0Mi42NjdIMzg0YzIzLjU3MywwLDQyLjY2Ny0xOS4wOTMsNDIuNjY3LTQyLjY2N3YtMjU2QzQyNi42NjcsODMuMDkzLDQwNy41NzMsNjQsMzg0LDY0eg0KCQkJIE0yMTMuMzMzLDM0MS4zMzNjLTU4Ljg4LDAtMTA2LjY2Ny00Ny43ODctMTA2LjY2Ny0xMDYuNjY3UzE1NC40NTMsMTI4LDIxMy4zMzMsMTI4UzMyMCwxNzUuNzg3LDMyMCwyMzQuNjY3DQoJCQlTMjcyLjIxMywzNDEuMzMzLDIxMy4zMzMsMzQxLjMzM3oiLz4NCgk8L2c+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8L3N2Zz4NCg==`
		const templateRowtable = rowObj =>
			`<div class="row" data-id="${rowObj.id || ''}">
				<div class="column">
					<picture>
						<source srcset="${imageThumbnail()}" media="(max-width: 500px)">
						<img src="${rowObj.img || ''}">
					</picture>
				</div>
				<div class="column">${rowObj.name || ''}</div>
				<div class="column">${rowObj.alias || ''}</div>
				<div class="column">${rowObj.price || ''}</div>
				<div class="column">${rowObj.date || ''}</div>
				<div class="controls_container">
					<div class="move"></div>
					<div class="select_item">
						<input type="checkbox">
						<span></span>
					</div>
				</div>
			</div>`
		function _getParents(el, parentSelector) {
			parentSelector || document
		    let parent = el.parentNode
		    while (parent !== parentSelector) {
		        let parentTMP = parent
		        parent = parentTMP.parentNode
		    }
		    return parentSelector
		}
		function loadImage(event) {
			// FileList object
			// Obtenemos la imagen del campo "file"
			files = event.target.files
			for (var index = 0, f; f = files[index]; index++) {
				//Solo admitimos imágenes.
				if (!f.type.match('image.*')) continue
				reader = new FileReader()
				reader.onload = (function(theFile) {
					return function(event) {
						tmpSrc			= event.target.result
						data			= {}
						_size			= " " + (((event.total / 1024) / 1024) * 1024).toFixed(2) + " KB"
						$imagen.title	= decodeURI(theFile.name) + _size
						adjustImage(tmpSrc)
					}
				})(f)
				reader.readAsDataURL(f)
			}
		}
		function wayToLoadTheImage() {
			$imagen.src			= ''
			$imageThumbnail.src	= ''
			$uploadImage.hidden	= !$uploadImage.hidden
			$imageUrl.hidden	= !$imageUrl.hidden
			if (this.checked) $imageUrl.focus()
		}
		function adjustImage(srcImage) {
			if (this === document.querySelector('#image_url')) srcImage = this.value
			$imageThumbnail.src	= srcImage
			$imagen.value		= srcImage
			setTimeout(function() {
				const width  = $imageThumbnail.width
				const height = $imageThumbnail.height
				$imageThumbnail.classList.remove('x', 'y')
				$imageThumbnail.classList.add(width > height ? 'x' : 'y')
			}, 300)
		}
		function enableForm() {
			const $form				= _getParents(this, document.querySelector('form'))
			const _totalRequired	= $form.querySelectorAll('[required]').length
			let _disabled			= true
			if (_totalRequired) {
				let total		= 0
				const $required	= $form.querySelectorAll('[required]')
				$required.forEach(function(require) {
					if (require.value) ++total
				})
				_disabled = total === _totalRequired ? false : true
			} else _disabled = false
			$form.querySelector('[type="submit"]').disabled = _disabled
		}
		function defaultImageByError() {
			this.src = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgMzA4LjggMzA4LjgiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwOC44IDMwOC44OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8Zz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNEE1NjZFOyIgZD0iTTM1LjYsMTguOGgxODBjMTkuNiwwLDM1LjYsMTYsMzUuNiwzNS42djE4NS4yYzAsMTkuNi0xNiwzNS42LTM1LjYsMzUuNmgtMTgwDQoJCUMxNiwyNzUuMiwwLDI1OS4yLDAsMjM5LjZWNTRDMCwzNC44LDE2LDE4LjgsMzUuNiwxOC44eiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiMwMEI1OTQ7IiBkPSJNMTE2LjQsMTg2LjRsLTUyLjgtNTIuOEwwLDE5Ny4ydjEzLjJ2MjguOGMwLDE5LjYsMTYsMzUuNiwzNS42LDM1LjZoMTgwYzE5LjYsMCwzNS42LTE2LDM1LjYtMzUuNg0KCQl2LTI4Ljh2LTM5LjZsLTU5LjYtNjBMMTE2LjQsMTg2LjR6Ii8+DQoJPGNpcmNsZSBzdHlsZT0iZmlsbDojRkZDQzAzOyIgY3g9IjExNC44IiBjeT0iMTAzLjYiIHI9IjIyLjQiLz4NCgk8Y2lyY2xlIHN0eWxlPSJmaWxsOiNGRkZGRkY7IiBjeD0iMjUxLjIiIGN5PSIyMzIuNCIgcj0iNTcuNiIvPg0KPC9nPg0KPGc+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzAwQjU5NDsiIGQ9Ik0yMjQsMjQwLjhjLTQuNCwwLTguNC0zLjYtOC40LTguNHMzLjYtOC40LDguNC04LjRoNTQuNGM0LjgsMCw4LjQsMy42LDguNCw4LjRzLTMuNiw4LjQtOC40LDguNA0KCQlIMjI0eiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiMwMEI1OTQ7IiBkPSJNMjU5LjYsMjU5LjZjMCw0LjgtMy42LDguNC04LjQsOC40cy04LjQtMy42LTguNC04LjR2LTU0YzAtNC40LDMuNi04LjQsOC40LTguNA0KCQljNC40LDAsOC40LDMuNiw4LjQsOC40VjI1OS42eiIvPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPC9zdmc+DQo="
		}
		function saveForm(event) {
			event.preventDefault()
			event.stopPropagation()
			const form	= this
			const info	= new FormData(form)
			let datas	= []
			let tokens	= []
			for (var pair of info.entries()) {
				tokens.push(pair[0])
				datas.push(pair[1])
			}
			if (!datas[0]) datas.shift() // Elimina la primera posición (id)
			tokens.shift()
			let queryInsert = `INSERT INTO metas (${tokens.map((i, item) => i)}) VALUES (${tokens.map((i, item) => '?')})`
			const status = window.app.insert(queryInsert, datas)
			if (status) {
				form.reset()
				showTable('metas')
			}
		}
		function showTable(nameTable) {
			app.getTable(nameTable, function(results) {
				html = ``
				for (key in results)
					html += templateRowtable(results[key])
				$tableContainer.innerHTML = html
			})
		}
		const $uploadImage		= document.querySelector('#upload_image')
		const $form				= document.querySelector('form')
		const $imagen			= document.querySelector('#imagen')
		const $tableContainer	= document.querySelector('#table_container')
		const $imageMode		= document.querySelector('#image_mode')
		const $imageThumbnail	= document.querySelector('#image_thumbnail')
		const $imageUrl			= document.querySelector('#image_url')
		const $inputs			= document.querySelectorAll('input, select, textarea')
		const init = () => {
			if (window.openDatabase) {
				window.app = new DB('finanzas')
				app.init()
				app.getTable('metas', function(results) {
					html = ``
					for (key in results)
					    html += templateRowtable(results[key])
					$tableContainer.innerHTML = html
				})
			} else console.error(messages.error_init)
		}
		window.addEventListener('load', init, false)
		$uploadImage.addEventListener('change', loadImage, false)
		$form.addEventListener('submit', saveForm, false)
		$imageMode.addEventListener('change', wayToLoadTheImage, false)
		$imageUrl.addEventListener('change', adjustImage, false)
		$imageThumbnail.addEventListener('error', defaultImageByError, false)
		$inputs.forEach(function(item) {
			item.addEventListener('change', enableForm, false)
		})
	</script>
</body>
</html>