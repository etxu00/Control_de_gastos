<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="description" content="Control de gastos, objetivos y más">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Finanzas</title>
	<style>
		*,
		*:before,
		*:after {
			box-sizing: border-box;
		}
		:root {
			--black: #212121;
			--font: #616161;
			--link: #007bff;
			--blue: #007bff;
			--purple: #a126ff;
			--min-height: calc(100vh - 18rem);
		}
		html {
			background: white;
			color: var(--font);
			font-family: 'Open Sans', 'Ubuntu', 'Century gothic', arial, sans-serif;
			font-size: 16px;
		}
		.input_container label *:not([hidden]) {
			width: 100%;
			display: block;
		}
		.input_container label {
			display: flex;
			flex-direction: column-reverse;
			margin-bottom: 1rem;
		}
	</style>
</head>
<body>
	<h1>Objetivo</h1>
	<form>
		<input id="id" name="id" type="hidden">
		<div class="input_container">
			<label>
				<input id="nombre" name="nombre" type="text">
				<span>Nombre</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="alias" name="alias" type="text">
				<span>Alias <small>(Nombre corto)</small></span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="precio" name="precio" type="number">
				<span>Monto</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="fecha" name="fecha" type="date">
				<span>Fecha</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="image_mode" type="checkbox">
				<span>Imagen por URL</span>
			</label>
		</div>
		<div class="input_container">
			<label>
				<input id="upload_image" type="file">
				<input id="image_url" type="url" placeholder="Pega la URL de la imagen" hidden>
				<span>Imagen</span>
			</label>
			<img id="image_thumbnail" src="">
			<input id="imagen" name="imagen" type="text">
		</div>
		<div class="input_container">
			<label>
				<select name="meta" id="meta" multiple>
					<option value=""></option>
					<option value="1">Setup Gammer</option>
					<option value="2">Ejemplo</option>
					<option value="3">Cocina de mis sueños</option>
				</select>
				<span>Meta</span>
			</label>
		</div>
		<button type="reset">Cancelar</button>
		<button type="submit">Aceptar</button>
	</form>
	<script>
		developerMode = true
		function errorHandler(transaction) {
			if (developerMode) console.error(transaction)
		}
		function loadImage(event) {
			// FileList object
			// Obtenemos la imagen del campo "file"
			files = event.target.files
			for (var index = 0, f; f = files[index]; index++) {
				//Solo admitimos imágenes.
				if (!f.type.match('image.*')) continue
				reader = new FileReader()
				reader.onload = (function(theFile) {
					return function(event) {
						// Creamos la imagen.
						tmpSrc				= event.target.result
						$imageThumbnail.src	= tmpSrc
						$imagen.value		= tmpSrc
            			data				= {}
						_size				= " " + (((event.total / 1024) / 1024) * 1024).toFixed(2) + " KB"
						$image.title		= decodeURI(theFile.name) + _size
						setTimeout(function() {
							x = $imageThumbnail.width
							y = $imageThumbnail.height
							if (x > y) {
								$imageThumbnail.classList.remove('y')
								$imageThumbnail.classList.add('x')
							} else {
								$imageThumbnail.classList.remove('x')
								$imageThumbnail.classList.add('y')
							}
						}, 300)
					}
				})(f)
				reader.readAsDataURL(f)
			}
		}
		function successHandler(message, data) {
			if (developerMode) console.info(message ? message : "Ok")
		}
		var message = {
			error_init : `En navegador con el que cuentas, no soporta las tecnologias requeridas para el funcionamiento de esta web app`
		}
		const $uploadImage		= document.querySelector('#upload_image')
		const $form				= document.querySelector('form')
		const $imagen			= document.querySelector('#imagen')
		const $imageMode		= document.querySelector('#image_mode')
		const $imageThumbnail	= document.querySelector('#image_thumbnail')
		const $imageUrl			= document.querySelector('#image_url')
		const init = () => {
			if (window.openDatabase) {
				db          = openDatabase('finanzas', '1.0', 'finanzas', 2 * 1024 * 1024) // Base de datos 2MB
				var createGoals = `CREATE TABLE IF NOT EXISTS metas (
																		id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
																		nombre TEXT NOT NULL,
																		alias TEXT,
																		precio REAL DEFAULT 0.00,
																		fecha TEXT,
																		imagen TEXT,
																		orden INTEGER DEFAULT 0,
																		fecha_creacion TEXT DEFAULT CURRENT_TIMESTAMP,
																		fecha_update TEXT DEFAULT CURRENT_TIMESTAMP,
																		estatus INTEGER DEFAULT 1
																	)`
				var deleteGoals = `DROP TABLE IF EXISTS metas`
				db.transaction(function(tx) {
					tx.executeSql(createGoals)
				}, errorHandler, successHandler("Se creo exitosamente"))
				db.transaction(function(tx) {
					tx.executeSql('SELECT * FROM metas', [], function(tx, data) {
						// console.log(data)
					})
				}, errorHandler, successHandler("Se creo exitosamente"))
				/*db.transaction(function(tx) {
					tx.executeSql(deleteGoals)
				}, errorHandler, successHandler("Se elimino correctamente"))*/
				document.querySelector('#nombre').focus()
			} else console.error(error_init)
		}
		window.addEventListener('load', init, false)
    	$uploadImage.addEventListener('change', loadImage, false)
		$form.addEventListener('submit', function() {
			event.preventDefault()
			event.stopPropagation()
			const form = this
			const info = new FormData(form)
			let data   = []
			for (var pair of info.entries())
				data.push(pair[1])
			if (!data[0]) data.shift()
			db.transaction(function(transaction) {
				const insert = 'INSERT INTO metas (nombre, alias, precio, fecha, imagen) VALUES (?, ?, ?, ?, ?)'
				transaction.executeSql(insert, data, function() {
					form.reset()
					$imageThumbnail.src = ''
					alert("Guardado")
				}, function(transaction, error) {
					error(error.message)
				})
			})
		}, false)
		$imageMode.addEventListener('change', function() {
			$imagen.src			= ''
			$uploadImage.hidden	= !$uploadImage.hidden
			$imageUrl.hidden	= !$imageUrl.hidden
		})
		$imageUrl.addEventListener('change', function() {
			$imageThumbnail.src	= this.value
			$imagen.value		= this.value
		}, false)
	</script>
</body>
</html>