<!DOCTYPE HTML>
<html class="no-js" lang="es-419">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Control de gastos</title>
  <meta name="description" content="Control de gastos, objetivos y más">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="//img.icons8.com/color/32/000000/check.png">

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Arial' Sans-serif;
      margin: 0;
    }
    form {
      padding: 1rem;
    }
    label {
      display: flex;
      flex-direction: column-reverse;
      margin-bottom: 1rem;
    }

    [hidden],
    .off {
      display: none !important;
    }
  </style>
</head>
<body>
  <h1>Control económico</h1>
  
  <nav>
    <ul>
      <li><span>Adeudos</span></li>
      <li><span>Ahorros</span></li>
      <li><span>Bitácora de gastos</span></li>
      <li><span>Objetivos</span></li>
      <li><span>Tarjetas de crédito</span></li>
    </ul>
  </nav>

  <section>
    <form id="form_objectives">
      <input name="id" type="hidden">
      <h2>Registro de egresos recurrentes</h2>
      <label>
        <input name="name" type="text" autocomplete="off" placeholder="Ejemplo: Internet, Renta, Gas, Luz, etc." required>
        <span>Nombre</span>
      </label>
      <label>
        <input name="amount" type="number" step='0.01' min="0.00" autocomplete="off" placeholder="0.00" required>
        <span>Monto</span>
      </label>
      <label>
        <input name="type_image" type="checkbox" data-role-toggle-on-off="#ct_file_image_objetive,#ct_src_image">
        <span>De enlace</span>
      </label>
      <label id="ct_file_image_objetive">
        <input name="image" type="file">
        <span>Imagen</span>
      </label>
      <label id="ct_src_image">
        <input name="src_image" type="url" autocomplete="off" placeholder="Ejemplo: https://image.png" >
        <span>Imagen</span>
      </label>
      <button type="submit">Aceptar</button>
      <button type="reset">Cancear</button>
      <h2>Egresos recurrentes</h2>
      <table id="table_services">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Monto</th>
            <th>Periodo</th>
            <th>Día de cobro</th>
          </tr>
        </thead>
        <tbody id="services"></tbody>
      </table>
    </form>
  </section>

  <section>
    <form id="form_services">
      <input name="id" type="hidden">
      <h2>Registro de egresos recurrentes</h2>
      <label>
        <input name="name" type="text" autocomplete="off" placeholder="Ejemplo: Internet, Renta, Gas, Luz, etc." required>
        <span>Nombre</span>
      </label>
      <label>
        <input name="amount" type="number" step='0.01' min="0.00" autocomplete="off" placeholder="0.00" required>
        <span>Monto</span>
      </label>
      <label>
        <select name="payment_period">
          <option value="">Seleccione una opción</option>
          <option value="0">Mensual</option>
          <option value="1">Anual</option>
        </select>
        <span>Periodo</span>
      </label>
      <label>
        <input name="day_to_pay" type="date" autocomplete="off">
        <span>Día de cobro</span>
      </label>
      <button type="submit">Aceptar</button>
      <button type="reset">Cancear</button>
      <h2>Egresos recurrentes</h2>
      <table id="table_services">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Monto</th>
            <th>Periodo</th>
            <th>Día de cobro</th>
          </tr>
        </thead>
        <tbody id="services"></tbody>
      </table>
    </form>
  </section>

  <section hidden>
    <form id="form_place">
      <input name="id" type="hidden">
      <h2>Registro de lugares</h2>
      <label>
        <input name="name" id="name" type="text" autocomplete="off" placeholder="Nombre del lugar (razón fiscal)" required>
        <span>Nombre</span>
      </label>
      <label>
        <input name="image" id="image" type="url" placeholder="Enlace web de la imagen">
        <span>Enlace de la imagen</span>
      </label>
      <button type="submit">Aceptar</button>
      <button type="reset">Cancear</button>
      <h2>Lugares</h2>
      <table id="table_Places">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Imagen</th>
          </tr>
        </thead>
        <tbody id="places"></tbody>
      </table>
    </form>
  </section>

  <section hidden>
    <form id="form_expenses">
      <input name="id" type="hidden">
      <h2>Registro de egresos</h2>
      <label>
        <input name="amount" id="amount" type="number" step='0.01' min="0.00" autocomplete="off" placeholder="0.00" required>
        <span>Monto</span>
      </label>
      <label>
        <select name="description" id="description" required>
          <option value="">Seleccione una opción</option>
          <option value="1">Internet</option>
          <option value="2">Renta</option>
          <option value="-1">Otro</option>
        </select>
        <span>Descripción</span>
      </label>
      <label>
        <input name="name_new_description" id="name_new_description" type="text" autocomplete="off" data-ui="hidden">
        <span>Nombre</span>
      </label>
      <label>
        <input name="new_description" id="new_description" type="checkbox" autocomplete="off" data-ui="hidden">
        <span>Agregar a lista de opciones de: "Descripción"</span>
      </label>
      <label>
        <select name="ubication" id="ubication">
          <option value="">Seleccione una opción</option>
          <option value="0">Oxxo</option>
          <option value="1">Walmart</option>
          <option value="-1">Otro</option>
        </select>
        <span>Lugar</span>
      </label>
      <label>
        <input name="name_new_ubication" id="name_new_ubication" type="text" autocomplete="off" data-ui="hidden">
        <span>Nombre</span>
      </label>
      <label>
        <input name="new_ubication" id="new_ubication" type="checkbox" autocomplete="off" data-ui="hidden">
        <span>Agregar a lista de opciones de: "Lugar"</span>
      </label>
      <label>
        <select name="way_pay" id="way_pay">
          <option value="">Seleccione una opción</option>
          <option value="">Tarjeta de crédito: Aeromexico</option>
          <option value="">Tarjeta de crédito: Efectivo</option>
          <option value="">Tarjeta de crédito: Free</option>
          <option value="">Tarjeta de crédito: Zero</option>
          <option value="">Cuenta paypal: Aeromexico</option>
          <option value="">Cuenta paypal: Efectivo</option>
          <option value="">Cuenta paypal: Free</option>
          <option value="-1">Otro</option>
        </select>
        <span>Forma de pago</span>
      </label>
      <label>
        <input name="date_purchase" id="date_purchase" type="date" autocomplete="off">
        <span>Fecha de compra</span>
      </label>
      <button type="submit">Aceptar</button>
      <button type="reset">Cancear</button>
    </form>
    <h2>Historial de egresos</h2>
    <table id="tableExpenses">
      <thead>
        <tr>
          <th>Descripción</th>
          <th>Lugar</th>
          <th>Forma de pago</th>
          <th>Fecha de compra</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody id="expenses"></tbody>
    </table>
  </section>

  <script>
    developer = false
    itemEdit  = null
    editItem  = false

    _services = {
                  services      : [],
                  top         : function(idPlace, numTop) {
                                  return 0
                                },
                  showItems   : function() {
                                  $tr = ''

                                  if (typeof(this.services) == 'string')
                                    this.services = stringToArrayObject(this.services)
                                  
                                  for (key in this.services) {
                                    _id            = this.services[key].id
                                    _name          = this.services[key].name
                                    _amount        = this.services[key].amount
                                    _paymentPeriod = this.services[key].payment_period
                                    _dayToPay      = this.services[key].day_to_pay

                                    // Formato nuevo
                                    _amount        = '$ ' + parseFloat(_amount).toFixed(2)
                                    _dayToPay      = convertDate(_dayToPay)

                                    _paymentPeriod == 0 ? _paymentPeriod = "Mensual" : _paymentPeriod = "Anual"

                                    $tr += '<tr data-id="' + _id + '" title="id: ' + _id + '. index: ' + key + '">'+
                                              '<td>' + _name + '</td>'+
                                              '<td>' + _amount + '</td>'+
                                              '<td>' + _paymentPeriod + '</td>'+
                                              '<td>' + _dayToPay + '<button class="btnEdit _btnEdit" type="button">Editar</button></td>'+
                                            '</tr>'
                                  }

                                  $services.innerHTML = ''
                                  $services.innerHTML = $tr

                                  for (key in $services.children) {
                                    if (key != 'length' && key != 'item' && key != 'namedItem') {
                                      lastNumItem = $services.children[key].children.length - 1
                                      $lastTd     = $services.children[key].children[lastNumItem]

                                      $services.children[key].addEventListener('click', function() {
                                        id = this.dataset.id

                                        loadItem(_services.services, $formServices, id)
                                        editItem = false
                                      })

                                      for (key in $lastTd.children) {
                                        if ($lastTd.children[0].classList.contains('_btnEdit')) {
                                          $lastTd.children[0].addEventListener('click', function() {
                                            editItem = true
                                          })
                                        }
                                      }
                                    }
                                  }

                                  this.create()
                                },
                  create      : function() {
                                  $html = '<option value="">Seleccione una opción</option>'
                                  
                                  for (key in this.services) {
                                    _value    = this.services[key].id
                                    _dataAttr = this.services[key].iamge
                                    _label    = this.services[key].name

                                    _dataAttr == undefined ? _dataAttr = '' : _dataAttr = ' data-image-src="' + _dataAttr + '"'
                    
                                    $html += '<option value="' + _value + '"' + _dataAttr + '>' + _label + '</option>'
                                  }
                    
                                  $html += '<option value="-1">Otro</option>'
                    
                                  $ubication.innerHTML = $html
                                },
                  addItem     : function(data) {
                                  if (!data.id) {
                                    id     = null
                                    services = _services.services
                                    
                                    _numItems = services.length

                                    if (_numItems > 0)
                                      newId = services[services.length -1].id + 1

                                    _numItems >= 1 ? id = newId : id = 1

                                    data.id = id

                                    services.push(data)
                                  } else {
                                    data.id            = parseInt(data.id)
                                    data.creation_date = _services.services[itemEdit].creation_date

                                    _services.services[itemEdit] = data
                                  }

                                  _services.showItems()
                                  localStorage.setItem('services', JSON.stringify(_services.services))
                                },
                  isThereItem : function(name) {
                                  result = false

                                  if (_services.services.length == 0)
                                    return false

                                  _services.services.forEach(function(item, index) {
                                    if (name == _services.services[index].name)
                                      result = true

                                    if (result)
                                      return true
                                  })

                                  return result
                                }
                }

    _expenses = {
                  expenses  : [],
                  showItems : function() {
                                $tr = ''

                                if (typeof(this.expenses) == 'string')
                                  this.expenses = stringToArrayObject(this.expenses)
                                
                                for (key in this.expenses) {
                                  _id           = this.expenses[key].id
                                  _name         = this.expenses[key].description
                                  _ubication    = this.expenses[key].ubication
                                  _wayPay       = this.expenses[key].way_pay
                                  _datePurchase = this.expenses[key].date_purchase
                                  _amount       = this.expenses[key].amount
                                  
                                  $tr += '<tr data-id="' + _id + '" title="id: ' + _id + '. index: ' + key + '">'+
                                            '<td>' + _name + '</td>'+
                                            '<td>' + _ubication + '</td>'+
                                            '<td>' + _wayPay + '</td>'+
                                            '<td>' + _datePurchase + '</td>'+
                                            '<td>$ ' + parseFloat(_amount).toFixed(2) + '<button class="btnEdit _btnEdit" type="button">Editar</button></td>'+
                                          '</tr>'
                                }

                                $expenses.innerHTML = ''
                                $expenses.innerHTML = $tr

                                for (key in $expenses.children) {
                                  if (key != 'length' && key != 'item' && key != 'namedItem') {
                                    lastNumItem = $expenses.children[key].children.length - 1
                                    $lastTd     = $expenses.children[key].children[lastNumItem]

                                    $expenses.children[key].addEventListener('click', function() {
                                      id = this.dataset.id

                                      loadItem(_expenses.expenses, $formExpenses, id)
                                      editItem = false
                                    })

                                    for (key in $lastTd.children) {
                                      if ($lastTd.children[0].classList.contains('_btnEdit')) {
                                        $lastTd.children[0].addEventListener('click', function() {
                                          editItem = true
                                        })
                                      }
                                    }
                                  }
                                }
                              },
                  create    : function() {
                                $html = '<option value="">Seleccione una opción</option>'
                                
                                for (key in this.description) {
                                  _value    = this.description[key].id
                                  _dataAttr = ' data-amount="' + this.description[key].amount + '"'
                                  _label    = this.description[key].name
       
                                  $html += '<option value="' + _value + '"' + _dataAttr + '>' + _label + '</option>'
                                }
       
                                $html += '<option value="-1">Otro</option>'
       
                                $description.innerHTML = $html
       
                                $description.addEventListener('change', function() {
                                  optionSelected = this.children[this.options.selectedIndex]
       
                                  if (optionSelected.getAttribute('data-amount') != null)
                                    $amount.value = parseFloat(optionSelected.dataset.amount)
                                })
                              },
                }

    _places   = {
                  places      : [],
                  top         : function(idPlace, numTop) {
                                  return 0
                                },
                  showItems   : function() {
                                $tr = ''

                                if (typeof(this.places) == 'string')
                                  this.places = stringToArrayObject(this.places)
                                
                                for (key in this.places) {
                                  _id    = this.places[key].id
                                  _name  = this.places[key].name
                                  _image = this.places[key].image

                                  _image != '' ? _image = "Si" : _image = "No"
                                  
                                  $tr += '<tr data-id="' + _id + '" title="id: ' + _id + '. index: ' + key + '">'+
                                            '<td>' + _name + '</td>'+
                                            '<td>' + _image + '<button class="btnEdit _btnEdit" type="button">Editar</button></td>'+
                                          '</tr>'
                                }

                                $places.innerHTML = ''
                                $places.innerHTML = $tr

                                for (key in $places.children) {
                                  if (key != 'length' && key != 'item' && key != 'namedItem') {
                                    lastNumItem = $places.children[key].children.length - 1
                                    $lastTd     = $places.children[key].children[lastNumItem]

                                    $places.children[key].addEventListener('click', function() {
                                      id = this.dataset.id

                                      loadItem(_places.places, $formPlace, id)
                                      editItem = false
                                    })

                                    for (key in $lastTd.children) {
                                      if ($lastTd.children[0].classList.contains('_btnEdit')) {
                                        $lastTd.children[0].addEventListener('click', function() {
                                          editItem = true
                                        })
                                      }
                                    }
                                  }
                                }

                                this.create()
                                },
                  create      : function() {
                                $html = '<option value="">Seleccione una opción</option>'
                                
                                for (key in this.places) {
                                  _value    = this.places[key].id
                                  _dataAttr = this.places[key].iamge
                                  _label    = this.places[key].name

                                  _dataAttr == undefined ? _dataAttr = '' : _dataAttr = ' data-image-src="' + _dataAttr + '"'
                  
                                  $html += '<option value="' + _value + '"' + _dataAttr + '>' + _label + '</option>'
                                }
                  
                                $html += '<option value="-1">Otro</option>'
                  
                                $ubication.innerHTML = $html
                                },
                  addItem     : function(data) {
                                  if (!data.id) {
                                    id     = null
                                    places = _places.places
                                    
                                    _numItems = places.length

                                    if (_numItems > 0)
                                      newId = places[places.length -1].id + 1

                                    _numItems >= 1 ? id = newId : id = 1

                                    data.id = id

                                    places.push(data)
                                  } else {
                                    data.id            = parseInt(data.id)
                                    data.creation_date = _places.places[itemEdit].creation_date

                                    _places.places[itemEdit] = data
                                  }

                                  _places.showItems()
                                  localStorage.setItem('places', JSON.stringify(_places.places))
                                },
                  isThereItem : function(name) {
                                  result = false

                                  if (_places.places.length == 0)
                                    return false

                                  _places.places.forEach(function(item, index) {
                                    if (name == _places.places[index].name)
                                      result = true

                                    if (result)
                                      return true
                                  })

                                  return result
                                }
                }

    $amount       = document.querySelector('#amount')
    $datePurchase = document.querySelector('#date_purchase')
    $description  = document.querySelector('#description')
    $expenses     = document.querySelector('#expenses')
    $services     = document.querySelector('#services')
    $formExpenses = document.querySelector('#form_expenses')
    $formPlace    = document.querySelector('#form_place')
    $formServices = document.querySelector('#form_services')
    $places       = document.querySelector('#places')
    $ubication    = document.querySelector('#ubication')
    
    $$resets      = document.querySelectorAll('[type="reset"]')
    $$selects     = document.querySelectorAll('select')
    $$tags        = document.querySelectorAll('[data-ui]')

    function convertDate(yyyymmdd) {
      function pad(tmp) {
        return (tmp < 10) ? '0' + tmp : tmp
      }
      
      newFormat = new Date(yyyymmdd)
      
      return [
               pad(newFormat.getDate() + 1),
               pad(newFormat.getMonth() + 1),
               newFormat.getFullYear()
             ].join('/')
    }

    function stringToArrayObject(string) {
      tmpArray   = []
      
      string = (new Function("return [" + string.slice(0, -1).substring(1) + "]")())

      for (key in string) {
        tmpArray.push(this.expenses[key])
      }

      return tmpArray
    }

    function changeSelect() {
      val    = parseInt(this.value)
      id     = this.id
      
      $check = document.querySelector('#new_' + id)
      $name  = document.querySelector('#name_new_' + id)

      if (val == -1) {
        $check.parentElement.classList.remove('off')
        $name.parentElement.classList.remove('off')

        $name.focus()
      } else {
        if ($check != null && $name != null) {
          $check.parentElement.classList.add('off')
          $name.parentElement.classList.add('off')
        }
      }
    }

    function resetForms(form) {
      form.id == undefined ? isForm = this.parentElement.nodeName : isForm = this.nodeName

      if (isForm == 'FORM') {
        $inputs = this.parentElement

        for (key in $inputs.children) {
          if (key != 'namedItem' && key != 'item' && key != 'length' && $inputs[key] != undefined) {
            $element = $inputs[key]

            $element.disabled = false

            if ($element.getAttribute('data-ui') != null)
              if ($element.parentElement.nodeName == 'LABEL')
                $element.parentElement.classList.add('off')
          }
        }
      }

      setTimeout(function() {
        $datePurchase.value = today()
      }, 10)
    }

    function addRegister(event) {
      event.preventDefault()

      dataTmp = new FormData(this)
      data    = {}
      id      = this.getAttribute('id')

      dataTmp.append('creation_date', new Date())

      dataTmp.forEach(function(value, key) {
        data[key] = value
      })

      if (id == 'form_expenses') {
        if (data.new_ubication == 'on') {
          if (!_places.isThereItem(data.name_new_ubication)) {
            dataUbication = {
                              creation_date : new Date(),
                              id            : '',
                              image         : '',
                              name          : data.name_new_ubication,
                            }

            _places.addItem(dataUbication)
          } else alert("La ubicación ya existe.")
        }

        if (!data.id) {
          id        = null
          expenses  = _expenses.expenses
          
          _numItems = expenses.length

          if (_numItems > 0)
            newId = expenses[expenses.length -1].id + 1

          _numItems >= 1 ? id = newId : id = 1

          data.id = id

          expenses.push(data)
        } else {
          data.id            = parseInt(data.id)
          data.creation_date = _expenses.expenses[itemEdit].creation_date

          _expenses.expenses[itemEdit] = data
        }

        _expenses.showItems()
        localStorage.setItem('expenses', JSON.stringify(_expenses.expenses))
      }

      if (id == 'form_place')
        if (!_places.isThereItem(data.name_new_ubication))
          _places.addItem(data)

      if (id == 'form_services')
        if (!_services.isThereItem(data.name))
          _services.addItem(data)

      resetForms(this)
      this.reset()
    }

    function loadItem(arrayObjects, $form, id) {
      item = null
      id   = parseInt(id)

      console.log(arrayObjects)

      for (key in arrayObjects) {
        if (arrayObjects[key].id === id) {
          item     = arrayObjects[key]
          itemEdit = parseInt(key)

          break
        }
      }

      for (key in $form.querySelectorAll('input[type="checkbox"]')) {
        $form.querySelectorAll('input[type="checkbox"]')[key].disabled = false
        $form.querySelectorAll('input')[key].disabled = false
      }

      for (key of Object.keys(item)) {
        if (document.querySelector('#' + key) != null) {
          $item       = document.querySelector('#' + key)
          $item.value = item[key]

          if ($item.type == 'checkbox' || $item.type == 'radio')
            if (item[key] == 'on')
              $item.checked = true

          if ($item.nodeName == 'SELECT')
            $item.onchange()

          !editItem ? $item.disabled = true : $item.disabled = false
        }

        $$buttons = $form.querySelectorAll('button[type="submit"]')

        for (key in $$buttons) {
          !editItem ? $$buttons[key].disabled = true : $$buttons[key].disabled = false
        }

      }


      /*$.each(item, function(index, val) {
        $item = $('#' + index)
        
        $item.val(val)

        if (!editObjetive)
          $item.prop('disabled', true)

        if (index == 'image')
          $imageThumb.attr('src', val)

        // $('yourimageselector').attr('src', 'newsrc').load(function() {
        //   this.width;   // Note: $(this).width() will not work for in memory images
        // })

        if (val == 'on')
          $('#' + index).prop('checked', true)
      })*/
    }

    function today() {
      date  = new Date()

      _day   = date.getDate()
      _month = date.getMonth() + 1
      _year  = date.getFullYear()

      if (_month < 10) _month = "0" + _month
      if (_day < 10) _day = "0" + _day

      _today = _year + "-" + _month + "-" + _day
      
      return _today
    }

    function showItems(string) {
      $tr = ''

      if (typeof(string) == 'string') {
        tmpObj             = []
        _expenses.expenses = (new Function("return [" + string.slice(0, -1).substring(1) + "]")())

        for (key in _expenses.expenses) {
          tmpObj.push(_expenses.expenses[key])
        }

        return tmpObj
      }
    }

    function toggleItem() {
      selector = this.dataset.roleToggleItem

      _typeSelector = selector.substr(0, 1)

      if (_typeSelector == '#' || _typeSelector == '.') {
        if (_typeSelector == '#') {
          $element = document.querySelector(selector)

        } else {
          $$elements = document.querySelectorAll(selector)

          $$elements.forEach(function($element) {
            $element.hidden ? $element.hidden = false : $element.hidden = true
          })
        }
      } else {
        console.error("El selector " + selector + " no es soportado. Solo de admite id's (#) o clases (.)")

        return true
      }
    }

    function toggleItemOnOff() {
      selectors = this.dataset.roleToggleOnOff

      selectors.split(',').forEach(function(selectorsValue){
        _typeSelector = selectorsValue.substr(0, 1)
        
        if (_typeSelector == '#' || _typeSelector == '.') {
          
        } else {
          console.error("El selector " + selector + " no es soportado. Solo de admite id's (#) o clases (.)")
          return true
        }
      })
    }

    function start() {
      $$elements = document.querySelectorAll('[data-role-toggle-item]')

      $$elements.forEach(function(element) {
        element.addEventListener('change', toggleItem, false)
      })

      $$elements = document.querySelectorAll('[data-role-toggle-on-off]')

      $$elements.forEach(function(element) {
        element.addEventListener('change', toggleItemOnOff, false)
      })

      if (localStorage.getItem('services')) {
        _services.services = localStorage.getItem('services')

        _services.services = showItems(_services.services)

        _services.showItems()
      } else
        if (developer)
          console.info("No hay servicios que mostrar")

      if (localStorage.getItem('places')) {
        _places.places = localStorage.getItem('places')

        _places.places = showItems(_places.places)

        _places.showItems()
      } else
        if (developer)
          console.info("No hay lugares que mostrar")
        
      if (localStorage.getItem('expenses')) {
        _expenses.expenses = localStorage.getItem('expenses')

        _expenses.expenses = showItems(_expenses.expenses)

        _expenses.showItems()
      } else
        if (developer)
          console.info("No hay egresos que mostrar")
    }

    $datePurchase.value    = today()
    
    $formExpenses.onsubmit = addRegister
    $formPlace.onsubmit    = addRegister
    $formServices.onsubmit = addRegister
    
    $$selects.forEach(function(select) {
      select.onchange = changeSelect
    })
    
    $$resets.forEach(function(element) {
      element.onclick = resetForms
    })
    
    $$tags.forEach(function(element) {
      isLabel = element.parentElement

      if (isLabel.nodeName == 'LABEL')
        isLabel.classList.add('off')
    })

    window.onload = start
  </script>
</body>
</html>