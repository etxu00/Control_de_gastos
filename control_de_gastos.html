<!DOCTYPE HTML>
<html class="no-js" lang="es-419">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Control de gastos</title>
  <meta name="description" content="Control de gastos, objetivos y más">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="//img.icons8.com/color/32/000000/check.png">

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Arial' Sans-serif;
      margin: 0;
    }
    form {
      padding: 1rem;
    }
    label {
      display: flex;
      flex-direction: column-reverse;
      margin-bottom: 1rem;
    }

    .off {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Control económico</h1>
  <nav>
    <ul>
      <li><span>Adeudos</span></li>
      <li><span>Ahorros</span></li>
      <li><span>Bitácora de gastos</span></li>
      <li><span>Objetivos</span></li>
      <li><span>Tarjetas de crédito</span></li>
    </ul>
  </nav>
  <section>
    <form id="form_expenses">
      <input name="id" id="id" type="hidden">
      <h2>Registro de egresos</h2>
      <label>
        <input name="amount" id="amount" type="number" step='0.01' min="0.00" autocomplete="off" placeholder="0.00">
        <span>Monto</span>
      </label>
      <label>
        <select name="description" id="description">
          <option value="0">Seleccione una opción</option>
          <option value="1">Internet</option>
          <option value="2">Renta</option>
          <option value="-1">Otro</option>
        </select>
        <span>Descripción</span>
      </label>
      <label>
        <input name="name_new_description" id="name_new_description" type="text" autocomplete="off" data-ui="hidden">
        <span>Nombre</span>
      </label>
      <label>
        <input name="new_description" id="new_description" type="checkbox" autocomplete="off" data-ui="hidden">
        <span>Agregar a lista de opciones de: "Descripción"</span>
      </label>
      <label>
        <select name="ubication" id="ubication">
          <option value="">Seleccione una opción</option>
          <option value="0">Oxxo</option>
          <option value="1">Walmart</option>
          <option value="-1">Otro</option>
        </select>
        <span>Lugar</span>
      </label>
      <label>
        <input name="name_new_ubication" id="name_new_ubication" type="text" autocomplete="off" data-ui="hidden">
        <span>Nombre</span>
      </label>
      <label>
        <input name="new_ubication" id="new_ubication" type="checkbox" autocomplete="off" data-ui="hidden">
        <span>Agregar a lista de opciones de: "Lugar"</span>
      </label>
      <label>
        <select name="way_pay" id="way_pay">
          <option value="">Seleccione una opción</option>
          <option value="">Tarjeta de crédito: Aeromexico</option>
          <option value="">Tarjeta de crédito: Efectivo</option>
          <option value="">Tarjeta de crédito: Free</option>
          <option value="">Tarjeta de crédito: Zero</option>
          <option value="">Cuenta paypal: Aeromexico</option>
          <option value="">Cuenta paypal: Efectivo</option>
          <option value="">Cuenta paypal: Free</option>
          <option value="-1">Otro</option>
        </select>
        <span>Forma de pago</span>
      </label>
      <label>
        <input name="date_purchase" id="date_purchase" type="date" autocomplete="off">
        <span>Fecha de compra</span>
      </label>
      <button type="submit">Aceptar</button>
      <button type="reset">Cancear</button>
    </form>
    <h2>Historial de egresos</h2>
    <table id="tableExpenses">
      <thead>
        <tr>
          <th>Descripción</th>
          <th>Lugar</th>
          <th>Forma de pago</th>
          <th>Fecha de compra</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody id="expenses"></tbody>
    </table>
  </section>

  <script>
    developer = true
    itemEdit  = null

    _expenses = {
                  expenses  : [],
                  showItems : function() {
                                $tr = ''

                                if (typeof(this.expenses) == 'string') {
                                  tmpExpenses   = []
                                  this.expenses = (new Function("return [" + this.expenses.slice(0, -1).substring(1) + "]")())

                                  for (key in this.expenses) {
                                    tmpExpenses.push(this.expenses[key])
                                  }

                                  this.expenses = tmpExpenses
                                }
                                
                                for (key in this.expenses) {
                                  _id           = this.expenses[key].id
                                  _nombre       = this.expenses[key].name_new_description
                                  _ubication    = this.expenses[key].ubication
                                  _wayPay       = this.expenses[key].way_pay
                                  _datePurchase = this.expenses[key].date_purchase
                                  _amount       = this.expenses[key].amount
                                  
                                  $tr += '<tr>'+
                                            '<td>' + _nombre + '</td>'+
                                            '<td>' + _ubication + '</td>'+
                                            '<td>' + _wayPay + '</td>'+
                                            '<td>' + _datePurchase + '</td>'+
                                            '<td>' + _amount + '</td>'+
                                          '</tr>'
                                }

                                $expenses.innerHTML = ''
                                $expenses.innerHTML = $tr
                              },
                  create    : function() {
                                $html = '<option value="">Seleccione una opción</option>'
                                
                                for (key in this.description) {
                                  _value  = this.description[key].id
                                  _amount = ' data-amount="' + this.description[key].amount + '"'
                                  _label  = this.description[key].name
       
                                  $html += '<option value="' + _value + '"' + _amount + '>' + _label + '</option>'
                                }
       
                                $html += '<option value="-1">Otro</option>'
       
                                $description.innerHTML = $html
       
                                $description.addEventListener('change', function() {
                                  optionSelected = this.children[this.options.selectedIndex]
       
                                  if (optionSelected.getAttribute('data-amount') != null)
                                    $amount.value = parseFloat(optionSelected.dataset.amount)
                                })
                              },
                }

    $formExpenses = document.querySelector('#form_expenses')
    $datePurchase = document.querySelector('#date_purchase')
    $description  = document.querySelector('#description')
    $amount       = document.querySelector('#amount')
    $expenses     = document.querySelector('#expenses')
    
    $$selects     = document.querySelectorAll('select')
    $$resets      = document.querySelectorAll('[type="reset"]')
    $$tags        = document.querySelectorAll('[data-ui]')

    function changeSelect() {
      val    = parseInt(this.value)
      id     = this.id
      
      $check = document.querySelector('#new_' + id)
      $name  = document.querySelector('#name_new_' + id)

      if (val == -1) {
        $check.parentElement.classList.remove('off')
        $name.parentElement.classList.remove('off')

        $name.focus()
      } else {
        if ($check != null && $name != null) {
          $check.parentElement.classList.add('off')
          $name.parentElement.classList.add('off')
        }
      }
    }

    function resetForms(form) {
      form.id == undefined ? isForm = this.parentElement.nodeName : isForm = this.nodeName

      if (isForm == 'FORM') {
        $form = this.parentElement

        for (key in $form.children) {
          if (key != 'namedItem' && key != 'item' && key != 'length' && $form[key] != undefined) {
            $element = $form[key]

            if ($element.getAttribute('data-ui') != null)
              if ($element.parentElement.nodeName == 'LABEL')
                $element.parentElement.classList.add('off')
          }
        }
      }

      $datePurchase.value = today()
    }

    function addRegister(event) {
      event.preventDefault()

      dataTmp = new FormData(this)
      data    = {}
      id      = this.getAttribute('id')

      dataTmp.append('creation_date', new Date())

      dataTmp.forEach(function(value, key) {
        data[key] = value
      })

      if (id == 'form_expenses') {
        if (data.amount == '') {
          _selector = '#' + id + ' input:not([type="hidden"])'
          
          alert("El monto es obligatorio")
          document.querySelector(_selector).focus()
          return
        } else {
          if (!data.id) {
            id        = null
            expenses  = _expenses.expenses
            
            _numItems = expenses.length

            if (_numItems > 0)
              newId = expenses[expenses.length -1].id + 1

            _numItems >= 1 ? id = newId : id = 1

            data.id = id

            expenses.push(data)
          } else {
            data.id       = parseInt(data.id)
            obj[itemEdit] = data
          }
        }
      }

      localStorage.setItem('expenses', JSON.stringify(expenses))

      console.log(data)
      resetForms(this)
      this.reset()
    }

    function today() {
      date  = new Date()

      _day   = date.getDate()
      _month = date.getMonth() + 1
      _year  = date.getFullYear()

      if (_month < 10) _month = "0" + _month
      if (_day < 10) _day = "0" + _day

      _today = _year + "-" + _month + "-" + _day
      
      return _today
    }

    function showItems(string) {
      $tr = ''

      if (typeof(string) == 'string') {
        tmpObj             = []
        _expenses.expenses = (new Function("return [" + string.slice(0, -1).substring(1) + "]")())

        for (key in _expenses.expenses) {
          tmpObj.push(_expenses.expenses[key])
        }

        return tmpObj
      }
    }

    function start() {
      if (localStorage.getItem('expenses')) {
        _expenses.expenses = localStorage.getItem('expenses')

        _expenses.expenses = showItems(_expenses.expenses)
      } else
        if (developer)
          console.info("No hay información egresos que mostrar")
    }

    $datePurchase.value = today()

    $formExpenses.onsubmit = addRegister
    
    $$selects.forEach(function(select) {
      select.onchange = changeSelect
    })
    
    $$resets.forEach(function(element) {
      element.onclick = resetForms
    })
    
    $$tags.forEach(function(element) {
      isLabel = element.parentElement

      if (isLabel.nodeName == 'LABEL')
        isLabel.classList.add('off')
    })

    window.onload = start
  </script>
</body>
</html>